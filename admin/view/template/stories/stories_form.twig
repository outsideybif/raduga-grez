{{ header }}{{ column_left }}



<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="submit" form="form-information" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>
        <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a></div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-information" class="form-horizontal"></form>
  <form id="deleteForm" action="/post/dispatch/delete" method="post"></form>



  <div class="container-fluid">{% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_form }}</h3>
      </div>
      <div class="panel-body">
       
          <ul class="nav nav-tabs">
            <li class="active"><a href="#tab-general" data-toggle="tab">{{ tab_general }}</a></li>

            {% if story != null %}
            <li><a href="#tab-data" data-toggle="tab">Content</a></li>
             {% endif %}

             <li><a href="#tab-video" data-toggle="tab">Video</a></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="tab-general">
            
                <h1>Header</h1>
                <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Title</label>
                  </div>
                  <div class="col-sm-12">
                    <input type="text" name="title" value="{{ story.title }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>
                  </div>
                </div>
                 


                <input type="hidden" name="category_id" value="{{ story.category_id }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>
                
                <input type="hidden" name="link" value="{{ story.link }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>


                <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Title image</label>
                  </div>
                  <div class="col-sm-12">
                    <a href="" id="thumb-image" data-toggle="image" class="img-thumbnail">
                      <img src="../image/{{ story.image }}" alt="" title="" style="width:200px" data-placeholder="{{ placeholder }}" />
                    </a>
                    <input type="hidden" name="image" value="{{ story.image }}" id="input-image" form="form-information"/>
                  </div>
                </div>










                <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Title color</label>
                  </div>
                  <div class="col-sm-12">
                    <input type="color" name="title_color" value="{{ story.title_color }}" form="form-information">
                  </div>
                  
                </div>

                 <h1>Footer</h1>

                 <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Photo</label>
                  </div>
                  <div class="col-sm-12">
                    <input type="text" name="author_photo" value="{{ story.author_photo }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>
                  </div>
                </div>

                 <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Style</label>
                  </div>
                  <div class="col-sm-12">
                    <input type="text" name="author_style" value="{{ story.author_style }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>
                  </div>
                </div>

                 <div class="form-group row" style="margin: 0;">
                  <div class="col-sm-12">
                    <label class="control-label">Video</label>
                  </div>
                  <div class="col-sm-12">
                    <input type="text" name="author_video" value="{{ story.author_video }}" placeholder="Title" id="input-title" class="form-control" form="form-information"/>
                  </div>
                </div>

               

                

               {# <td class="text-left">

                <a href="" id="thumb-image1" data-toggle="image" class="img-thumbnail" data-original-title="" title="">
                  <img src="" alt="" title="" data-placeholder="">
                </a> 
                <input type="hidden" name="image" value="" id="input-image1">

              </td> #}

             




            </div>
            <div class="tab-pane" id="tab-data">
              
              

              <span id="blocks-wrapper">
                {% for ct in cnt %}
                <div class="form-group" style="margin: 0;" id="form-block-{{ct.custom_block_id}}">
                  <h2>{{ct.name}}</h2>
                  {% for vari in ct.variables %}

                    <label class="control-label" for="block_variable[{{ vari.custom_variable_value_id }}]">{{ vari.name }}</label>
                    
                    {% if vari.custom_variable_type_id == 1 %}
                      <input type="text" name="block_variable[{{ vari.custom_variable_value_id }}]" value="{{ vari.value }}" placeholder="{{ entry_sort_order }}" class="form-control" form="form-information"/>
                    {% endif %}

                    {% if vari.custom_variable_type_id == 2 %}
                      <div>
                          <a href="" id="thumb-image{{ vari.custom_variable_value_id }}" data-toggle="image" class="img-thumbnail">
                            <img src="../image/{{ vari.value }}" alt="" title="" style="width:200px" data-placeholder="{{ placeholder }}" />
                          </a>
                          <input type="hidden" name="block_variable[{{ vari.custom_variable_value_id }}]" value="{{ vari.value }}" id="input-image{{ vari.custom_variable_value_id }}" form="form-information"/>
                        </div>
                    {% endif %}

                    

                    
                    {# <li><a href="">{{ vari.name }}-{{vari.custom_variable_value_id}}</a></li> #}
                  {% endfor %}
                   </div>
                   <button type="button" data-block-id="{{ct.custom_block_id}}"  class="btn btn-danger remove-block" data-original-title="Remove"><i class="fa fa-minus-circle"></i></button>
                {% endfor %}
              </span>



              <div class="input-group">
                <select id="blocks-select" class="form-control input-sm">
                 
                  <optgroup label="Text">
                  {% for item in blocks %}
                    
                    <option value="{{item.custom_block_template_id}}">{{item.name}}</option>
                  {% endfor %}
                 
                  </optgroup>


                </select>
                <div class="input-group-btn">
                  <button id="add-block" type="button" onclick="" data-toggle="tooltip" title="" class="btn btn-primary btn-sm" data-original-title="Add Module"><i class="fa fa-plus-circle"></i></button>
                </div>
              </div>
              



            </div>
            




            
            <div class="tab-pane" id="tab-video">

              




















                <div class="form-group" style="margin: 0;">
                  <div class="col-sm-12">  
                    <p><b>Current video</b></p>
                    <video autoplay muted loop id="myVideo" style="width: 200px;min-height:100px;object-fit:cover;">

                      {% if story.video !=  "" %}
                        <source id="video_source" src="../{{ story.video }}" type="video/mp4">
                      {% endif %}
                      {% if story.video ==  "" %}
                        <source id="video_source" src="../public/gallery/empty.mp4" type="video/mp4">
                      {% endif %}
                      Your browser does not support HTML5 video.
                    </video>

                    <br><br><br>
                    <p><b>Load new video</b></p>

                    <p id="support-notice">Your browser does not support Ajax uploads<br/>The form will be submitted as normal.</p>

                    <form action="{{button_save}}" method="post" enctype="multipart/form-data" id="form-id">
                      <input id="file-id" type="file" name="our-file" />
                      <br>
                      <input type="button" value="Upload" id="upload-button-id" disabled="disabled" />
                      <p id="progress"></p>
                    </form>
                    

                    <script>

                      var video = document.getElementById('myVideo');
                      function supportAjaxUploadWithProgress() {
                        return supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();
                        function supportFileAPI() {
                          var fi = document.createElement('INPUT');
                          fi.type = 'file';
                          return 'files' in fi;
                        };
                        function supportAjaxUploadProgressEvents() {
                          var xhr = new XMLHttpRequest();
                          return !! (xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));
                        };
                        function supportFormData() {
                          return !! window.FormData;
                        }
                      }
                    
                      if (supportAjaxUploadWithProgress()) {
                        var notice = document.getElementById('support-notice');
                        var uploadBtn = document.getElementById('upload-button-id');
                        notice.innerHTML = "Your browser supports HTML uploads.";
                        uploadBtn.removeAttribute('disabled');
                        initFullFormAjaxUpload();
                        initFileOnlyAjaxUpload();
                      }
                    
                      function initFullFormAjaxUpload() {
                        var form = document.getElementById('form-id');
                        console.log(form);
                        form.onsubmit = function() {
                          var formData = new FormData(form);
                          var action = form.getAttribute('action');
                          console.log(action);
                          sendXHRequest(formData, action);
                          return false;
                        }
                      }
                    
                      function initFileOnlyAjaxUpload() {
                        var uploadBtn = document.getElementById('upload-button-id');
                        uploadBtn.onclick = function (evt) {
                          var formData = new FormData();
                          var action = '{{button_save}}';
                          action = `https://radugagrez.palemiya.com/admin/index.php?route=stories/stories/uploadStoryVideo&user_token={{user_token}}&story_id={{story.story_id}}`;
                          console.log(action);
                          var fileInput = document.getElementById('file-id');
                          var file = fileInput.files[0];
                          console.log(file);

                          video.pause();
                          $("#video_source").attr("src", "../public/video/" + file.name);
                          video.load();
                          video.play();

                          formData.append('our-file', file);
                          sendXHRequest(formData, action);
                        }
                      }
                    
                      function sendXHRequest(formData, uri) {
                        var xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener('loadstart', onloadstartHandler, false);
                        xhr.upload.addEventListener('progress', onprogressHandler, false);
                        xhr.upload.addEventListener('load', onloadHandler, false);
                        xhr.addEventListener('readystatechange', onreadystatechangeHandler, false);
                        xhr.open('POST', uri, true);
                        xhr.send(formData);
                      }
                      
                      function onloadstartHandler(evt) {
                        var div = document.getElementById('upload-status');
                        div.innerHTML = 'Upload started.';
                      }
                      function onloadHandler(evt) {
                        var div = document.getElementById('upload-status');
                        div.innerHTML += '<' + 'br>File uploaded. Waiting for response.';
                      }
                      function onprogressHandler(evt) {
                        var div = document.getElementById('progress');
                        var percent = evt.loaded/evt.total*100;
                        div.innerHTML = 'Progress: ' + percent + '%';
                      }
                      function onreadystatechangeHandler(evt) {
                        var status, text, readyState;
                        
                        try {
                          readyState = evt.target.readyState;
                          text = evt.target.responseText;
                          status = evt.target.status;
                          
                        }
                        catch(e) {
                          return;
                        }
                        console.log(readyState, status, evt);
                        if (readyState == 4 && status == '200' && evt.target.responseText) {
                          var status = document.getElementById('upload-status');
                          status.innerHTML += '<' + 'br>Success!';
                      
                          var result = document.getElementById('result');
                          result.innerHTML = '<p>The server saw it as:</p><pre>' + evt.target.responseText + '</pre>';
                        }
                      }
                    </script>
                    
                    <br><br>
                    <p><b>Remove video</b> </p>

                    <button id="remove_video">Remove video</button>



                    <script>

                      $('#remove_video').click(function(){
                        video.pause();
                        $("#video_source").attr("src", "../public/gallery/empty.mp4");
                        video.load();
                        video.play();
                        $.ajax({
                          url: `index.php?route=stories/stories/deletevideo&user_token={{user_token}}&story_id={{story.story_id}}`,
                          type: 'post',
                          data: {
                            name: $('#input-image').val()
                          },
                          dataType: 'json',
                          success: function(json) {
                            console.log(json);
                          
                          },
                          error: function(xhr, ajaxOptions, thrownError) {
                            console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                          }
                        });


                      })
                    </script>


                  </div>
                </div> 

























            </div>



          </div>
       
      </div>
    </div>
  </div>































         







































{# {% for ct in content %}
  <li><a href="">{{ ct.content }}</a></li>
{% endfor %} #}









{# <div class="form-group" style="margin: 0;">
                  <h2>{{ct.name}}</h2>
                  {% for vari in ct.variables %}

                    <label class="control-label" for="block_variable[{{ vari.custom_variable_value_id }}]">{{ vari.name }}</label>
                    
                    {% if vari.custom_variable_type_id == 1 %}
                      <input type="text" name="block_variable[{{ vari.custom_variable_value_id }}]" value="{{ vari.value }}" placeholder="{{ entry_sort_order }}" class="form-control"/>
                    {% endif %}

                    {% if vari.custom_variable_type_id == 2 %}
                      <div>
                          <a href="" id="thumb-image{{ vari.custom_variable_value_id }}" data-toggle="image" class="img-thumbnail">
                            <img src="../image/{{ vari.value }}" alt="" title="" style="width:200px" data-placeholder="{{ placeholder }}" />
                          </a>
                          <input type="hidden" name="block_variable[{{ vari.custom_variable_value_id }}]" value="{{ vari.value }}" id="input-image{{ vari.custom_variable_value_id }}" />
                        </div>
                    {% endif %}

                    
                    
                  {% endfor %}
                   </div> #}



<script>

$("body").on("click", ".remove-block", function(event){
  let blockId = $(this).data("block-id");
  $(this).remove();
  $(`#form-block-${blockId}`).remove();
  $.ajax({
    url: `index.php?route=stories/stories/removeBlock&user_token={{ user_token }}&block_id=${blockId}`,
    dataType: 'json',
    success: function(json) {
      
      
      

    },
     error: function(xhr, ajaxOptions, thrownError) {
          console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
  });



});



$("#add-block").on("click", ()=>{
  var e = document.getElementById("blocks-select");
  var blockId = e.options[e.selectedIndex].value;

  $.ajax({
    url: `index.php?route=stories/stories/addBlock&user_token={{ user_token }}&block_id=${blockId}&story_id={{story.story_id}}`,
    dataType: 'json',
    success: function(json) {
      

      let block = json["content"];
      let element = `<div class="form-group" style="margin: 0;" id="form-block-${block.custom_block_id}">
      <h2>${block.name}</h2>`;

      block.variables.forEach(vari => {
				element += `<label class="control-label" for="block_variable[${ vari.custom_variable_value_id }]">${ vari.name }</label>`;

        if(vari.custom_variable_type_id == 1){
          element += `<input type="text" name="block_variable[${ vari.custom_variable_value_id }]" value="${ vari.value }"  class="form-control" form="form-information"/>`
        }
        if(vari.custom_variable_type_id == 2){
            element += `<div>
              <a href="" id="thumb-image${ vari.custom_variable_value_id }" data-toggle="image" class="img-thumbnail">
                <img src="../image/${ vari.value }" alt="" title="" style="width:200px" />
              </a>
              <input type="hidden" name="block_variable[${ vari.custom_variable_value_id }]" value="${ vari.value }" id="input-image${ vari.custom_variable_value_id }" form="form-information"/>
            </div>`;
        }
			});

      element += `</div>`;
      element += ` <button type="button" data-block-id="${block.custom_block_id}"  class="btn btn-danger remove-block" data-original-title="Remove"><i class="fa fa-minus-circle"></i></button>`;

      $("#blocks-wrapper").append(element);

      console.log(json);
    },
     error: function(xhr, ajaxOptions, thrownError) {
          console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
  });

});



</script>



























  <link href="view/javascript/codemirror/lib/codemirror.css" rel="stylesheet" />
  <link href="view/javascript/codemirror/theme/monokai.css" rel="stylesheet" />
  <script type="text/javascript" src="view/javascript/codemirror/lib/codemirror.js"></script> 
  <script type="text/javascript" src="view/javascript/codemirror/lib/xml.js"></script> 
  <script type="text/javascript" src="view/javascript/codemirror/lib/formatting.js"></script> 
  <script type="text/javascript" src="view/javascript/summernote/summernote.js"></script>
  <link href="view/javascript/summernote/summernote.css" rel="stylesheet" />
  <script type="text/javascript" src="view/javascript/summernote/summernote-image-attributes.js"></script> 
  <script type="text/javascript" src="view/javascript/summernote/opencart.js"></script> 
  <script type="text/javascript"><!--
$('#language a:first').tab('show');
//--></script></div> #}
{{ footer }} 
